---
meta:
  productName: "terraform-google-executors"
  owners:
    - "sourcegraph"
  repository: "github.com/sourcegraph/terraform-google-executors"
  artifacts:
    - "nothing"
requirements:
  - name: "comby exists"
    cmd: "which comby"
    fixInstructions: "install comby"
  - name: "GitHub cli exists"
    cmd: "which gh"
    fixInstructions: "install GitHub cli"
input:
  - image_family
  - prev_version

# No internal steps since any release in this repo is public

test:
  steps:
    - name: "correct amount of versions changed made to README files"
      cmd: |
        count=$(comby -match-only '{{tag}}' '' -f .md | wc -l)
        expected=21
        if [[ ${count} -ne ${expected} ]]; then
          echo "expected ${expected} changes to README.md files, got ${count}"
          exit 1
        fi
    - name: "correct amount of new version tags in README"
      cmd: |
        count=$(grep -c '{{tag}}' README.md)
        expected=7
        if [[ ${count} -ne ${expected} ]]; then
          echo "expected ${expected} new version tags of \"{{tag}}\" in README.md, got ${count}"
          exit 1
        fi
    - name: "correct amount of changes to .tf files"
      cmd: |
        count=$(comby -match-only '"{{tag}}"' '' -f .tf | wc -l)
        expected=6
        if [[ ${count} -ne ${expected} ]]; then
          echo "expected ${expected} .tf files to be updated with \"{{tag}}\" but got ${count}"
          exit 1
        fi
    - name: "docker-mirror image family updated"
      cmd: |
        count=$(comby -match-only '"sourcegraph-executors-docker-mirror-{{inputs.image_family.tag}}"' '' -f .tf | wc -l)
        expected=1
        if [[ ${count} -ne ${expected} ]]; then
          echo "expected ${expected} .tf files to be updated with \"sourcegraph-executors-docker-mirror-{{inputs.image_family.tag}}\" but got ${count}"
          exit 1
        fi
    - name: "sourcegraph-executors image family updated"
      cmd: |
        count=$(comby -match-only '"sourcegraph-executors-{{inputs.image_family.tag}}"' '' -f .tf | wc -l)
        expected=1
        if [[ ${count} -ne ${expected} ]]; then
          echo "expected ${expected} .tf files to be updated with \"sourcegraph-executors-{{inputs.image_family.tag}}\" but got ${count}"
          exit 1
        fi
promoteToPublic:
  create:
    steps:
      - name: "update links in READMEs"
        cmd: comby -in-place '{{inputs.prev_version.tag}}' '{{tag}}' -f .md
      - name: "update version in examples"
        cmd: comby '"{{inputs.prev_version.tag}}"' '"{{tag}}"' -i -f .tf -exclude providers.tf
      - name: "update executors docker-mirror image name"
        cmd: comby '"sourcegraph-executors-docker-mirror-:[~\d+-\d+]"' '"sourcegraph-executors-docker-mirror-{{inputs.image_family.tag}}"' -i -f .tf
      - name: "update executors image name"
        cmd: comby '"sourcegraph-executors-:[~\d+-\d+]"' '"sourcegraph-executors-{{inputs.image_family.tag}}"' -i -f .tf
finalize:
  steps:
      - name: "create new branch"
        cmd: git switch -c "wb/wip-release-{{tag}}"
      - name: "add changes branch"
        cmd: "git commit -am 'WB-WIP: Test Release {{tag}}' -m 'This is a Test release'"
      - name: "push branch"
        cmd: "git push origin wb/wip-release-{{tag}}"
      - name: "create release PR"
        cmd: gh pr create --draft --fill
      # TODO: should we tag here ???
